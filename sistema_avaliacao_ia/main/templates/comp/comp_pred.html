{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }} - Predicto{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/comp_detail.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="comp-detail-layout">

    <div class="comp-main-content">
        <h1>{{ titulo }}</h1>
        <p class="subtitle">{{ descricao }}</p>

        <h2>Descrição</h2>
        <p>{{ descricao }}</p>

        <h2>Dados</h2>
        <p>Baixe os arquivos necessários para a competição.</p>
        <div class="download-buttons">
            <button onclick="window.location.href='/api/comp/download-competition-file/{{ compid }}/0/'">Baixar Dataset Treino/Teste</button>
            <button onclick="window.location.href='/api/comp/download-competition-file/{{ compid }}/1/'">Baixar Dataset Submissão</button>
        </div>

        <h2>Top 20 – Ranking</h2>
        <table class="ranking-table">
            <thead>
                <tr>
                    <th>Equipe</th>
                    <th>Score</th>
                </tr>
            </thead>

            <tbody>
                {% for item in ranking_top20 %}
                <tr>
                    <td>{{ item.0 }}</td>
                    <td>{{ item.1 }}</td>
                </tr>
                {% empty %}
                <tr class="ranking-table-empty">
                    <td colspan="2">Nenhum participante rankeado ainda.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="comp-sidebar">
        {% if not user_has_team %}
        <a href="{% url 'main:create-team' compid %}" style="text-decoration: none;" class="button-container">
            <button>Inscrever Equipe</button>
        </a>
        {% endif %}

        <a href="{% url 'main:comp-report' compid %}" style="text-decoration: none;" class="button-container">
            <button type="button" class="btn-secondary" style="width:100%;">Gerar Relatório</button>
        </a>

        <div class="sidebar-pod">
            <h3>Host da Competição</h3>
            <ul>
                <li>{{ organizador }}</li>
            </ul>
        </div>
        
        {% if user_has_team %}
        <div class="sidebar-pod" id="team-management-pod" data-compid="{{ compid }}" data-equipeid="{{ equipe_id }}" data-currentuserid="{{ current_user_id }}">
            <h3>Sua Equipe</h3>
            <ul id="team-member-list" class="team-member-list">
                {% for member in team_members %}
                <li class="team-member-item" id="member-item-{{ member.0 }}">
                    <span>{{ member.1 }}</span>
                    <button type="button" class="remove-member-btn" data-userid="{{ member.0 }}">×</button>
                </li>
                {% endfor %}
            </ul>
            <div class="team-search-container">
                <input type="text" id="team-user-search" placeholder="Adicionar novo membro...">
                <div id="team-search-results" class="team-search-results" style="display: none;"></div>
            </div>
            
            <h3 class="submission-form-title">Submissões</h3>
            <table class="comp-table">
                <thead>
                    <tr>
                        <th>Data de Envio</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in submissoes %}
                        <tr>
                            <td>{{ sub.0 }}</td>
                            <td>{{ sub.1 }}</td>
                        </tr>
                    {% empty %}
                        <tr class="comp-table-empty">
                            <td colspan="2">Nenhuma submissão ainda.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <form 
                action="{% url 'main:comp-submission' compid=compid equipeid=equipe_id %}"
                method="POST"
                enctype="multipart/form-data"
            >
                {% csrf_token %}
                <input type="hidden" name="comp_hidden" value="{{ compid }}">
                <input type="file" accept=".csv" name="submission-input" class="submission-form-file">
                <button class="submission-form-button" type="submit">Enviar Submissão</button>
            </form>
        </div>
        {% endif %}

        <div class="sidebar-pod">
            <h3>Prêmios e Reconhecimento</h3>
            <ul>
                <li>
                    {% if flg_oficial == 1 %}
                        <strong>R$ {{ premiacao|floatformat:2 }}</strong>
                    {% else %}
                        <strong>Não oficial</strong>
                    {% endif %}
                </li>
            </ul>
        </div>

        <div class="sidebar-pod">
            <h3>Participação</h3>
            <ul>
                <li><strong>{{ n_equipes }}</strong> Equipes</li>
                <li><strong>{{ n_comp }}</strong> Competidores Ativos</li>
            </ul>
        </div>
        
        <div class="sidebar-pod">
            <h3>Informações</h3>
            <ul>
                <li><strong>Dificuldade:</strong> {{ dificuldade }}</li>
                <li><strong>Métrica:</strong> {{ metrica_desempenho }}</li>
                <li><strong>Início:</strong> {{ data_inicio|date:"d M Y" }}</li>
                <li><strong>Fim:</strong> {{ data_fim|date:"d M Y" }}</li>
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
    {% if user_has_team %}
        <script src="{% static 'js/team_manage.js' %}"></script>
    {% endif %}
{% endblock %}